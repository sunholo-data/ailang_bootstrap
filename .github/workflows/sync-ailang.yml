name: Sync with AILANG Releases

on:
  # Check daily for new AILANG releases
  schedule:
    - cron: '0 6 * * *'  # 6 AM UTC daily
  # Manual trigger
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-and-sync:
    name: Check for new AILANG release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest AILANG version
        id: ailang
        run: |
          AILANG_VERSION=$(curl -sL https://api.github.com/repos/sunholo-data/ailang/releases/latest | jq -r '.tag_name')
          echo "version=$AILANG_VERSION" >> $GITHUB_OUTPUT
          echo "Latest AILANG version: $AILANG_VERSION"

      - name: Get current bootstrap version
        id: current
        run: |
          CURRENT_VERSION=$(jq -r '.version' gemini-extension.json)
          echo "version=v$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current bootstrap version: v$CURRENT_VERSION"

      - name: Check if update needed
        id: check
        run: |
          AILANG="${{ steps.ailang.outputs.version }}"
          CURRENT="${{ steps.current.outputs.version }}"

          if [ "$AILANG" != "$CURRENT" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "New version available: $AILANG (current: $CURRENT)"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "Already up to date: $CURRENT"
          fi

      - name: Update version in manifests
        if: steps.check.outputs.needs_update == 'true'
        run: |
          VERSION="${{ steps.ailang.outputs.version }}"
          VERSION_NUM="${VERSION#v}"  # Remove 'v' prefix

          # Update gemini-extension.json
          jq --arg v "$VERSION_NUM" '.version = $v' gemini-extension.json > tmp.json && mv tmp.json gemini-extension.json

          # Update plugin.json
          jq --arg v "$VERSION_NUM" '.version = $v' .claude-plugin/plugin.json > tmp.json && mv tmp.json .claude-plugin/plugin.json

          echo "Updated manifests to version $VERSION_NUM"
          cat gemini-extension.json
          cat .claude-plugin/plugin.json

      - name: Commit and tag
        if: steps.check.outputs.needs_update == 'true'
        run: |
          VERSION="${{ steps.ailang.outputs.version }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add gemini-extension.json .claude-plugin/plugin.json
          git commit -m "Sync with AILANG $VERSION"
          git tag "$VERSION"
          git push origin main --tags

      - name: Trigger release workflow
        if: steps.check.outputs.needs_update == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh workflow run release.yml -f ailang_version=${{ steps.ailang.outputs.version }}
          echo "Triggered release workflow for ${{ steps.ailang.outputs.version }}"
